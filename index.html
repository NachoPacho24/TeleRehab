<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TeleRehab – MVP (MediaPipe Tasks)</title>
  <style>
    :root { --bg:#0b1020; --card:#121933; --text:#e9eefc; --accent:#6aa7ff; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    header{padding:16px 20px;border-bottom:1px solid #1e2748;display:flex;gap:12px;align-items:center;justify-content:space-between}
    header h1{font-size:18px;margin:0;font-weight:600}
    main{padding:16px;display:grid;gap:16px;grid-template-columns:1fr;max-width:1100px;margin:0 auto}
    .panel{background:var(--card);border:1px solid #1e2748;border-radius:14px;padding:14px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    label{font-size:13px;opacity:.9}
    select,button,input[type="checkbox"]{background:#0e1530;color:var(--text);border:1px solid #273055;border-radius:10px;padding:8px 10px;font-size:14px}
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#0b1020;border-color:#6aa7ff;font-weight:600}
    #stage{position:relative;max-width:900px;margin:0 auto}
    video{display:none}
    canvas{width:100%;height:auto;border-radius:14px;border:1px solid #1e2748;background:#000}
    .badge{position:absolute;top:12px;left:12px;background:#0e1530cc;border:1px solid #273055;color:var(--text);padding:8px 10px;border-radius:10px;font-size:14px;backdrop-filter: blur(4px)}
    .stats{display:flex;gap:10px;flex-wrap:wrap}
    .stat{background:#0e1530;border:1px solid #273055;border-radius:12px;padding:10px 12px;min-width:100px;text-align:center}
    .stat .label{font-size:12px;opacity:.75}
    .stat .value{font-size:22px;font-weight:700;margin-top:2px}
    .tips{font-size:13px;opacity:.9;line-height:1.5}
    footer{padding:10px 16px;color:#9fb2e8;font-size:12px;opacity:.8;text-align:center}
  </style>
</head>
<body>
  <header>
    <h1>TeleRehab · MVP (MediaPipe Tasks Pose)</h1>
    <div class="row">
      <button id="btnStart" class="primary">Iniciar cámara</button>
      <button id="btnStop">Detener</button>
      <label><input type="checkbox" id="chkVoice" checked> Voz</label>
      <label>
        Ejercicio:
        <select id="exercise">
          <option value="arm_right">Elevación de brazo derecho</option>
          <option value="arm_left">Elevación de brazo izquierdo</option>
          <option value="knee_right">Flexión de rodilla derecha</option>
          <option value="knee_left">Flexión de rodilla izquierda</option>
        </select>
      </label>
      <label>
        Resolución:
        <select id="resolution">
          <option value="640x480" selected>640×480</option>
          <option value="960x540">960×540</option>
          <option value="1280x720">1280×720</option>
        </select>
      </label>
    </div>
  </header>

  <main>
    <section class="panel" id="stage">
      <div class="badge">
        <div class="stats">
          <div class="stat"><div class="label">Repeticiones</div><div class="value" id="reps">0</div></div>
          <div class="stat"><div class="label">Ángulo</div><div class="value" id="angle">–</div></div>
          <div class="stat"><div class="label">FPS</div><div class="value" id="fps">–</div></div>
        </div>
      </div>
      <video id="input_video" playsinline></video>
      <canvas id="output_canvas"></canvas>
    </section>

    <section class="panel">
      <strong>Indicaciones rápidas</strong>
      <ul class="tips">
        <li>De pie, con luz frontal y fondo simple. Mantén todo el cuerpo dentro del encuadre.</li>
        <li>Brazos: eleva hasta casi la línea de la cabeza. Rodilla: flexiona como si fueras a sentarte.</li>
        <li>Se cuenta una repetición al completar el ciclo <em>abajo → arriba → abajo</em>.</li>
      </ul>
    </section>
  </main>

  <footer>
    Procesamiento on‑device. No se envía video a servidores. MVP educativo.
  </footer>

  <!-- MediaPipe Tasks Vision Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"></script>

  <script>
    // ===== Utilidades generales =====
    const videoEl = document.getElementById('input_video');
    const canvasEl = document.getElementById('output_canvas');
    const ctx = canvasEl.getContext('2d');
    const repsEl = document.getElementById('reps');
    const angleEl = document.getElementById('angle');
    const fpsEl = document.getElementById('fps');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const selExercise = document.getElementById('exercise');
    const selRes = document.getElementById('resolution');
    const chkVoice = document.getElementById('chkVoice');

    let landmarker = null;
    let stream = null;
    let animId = null;
    let reps = 0;
    let phase = 'down';
    let frames = 0;
    let lastTs = performance.now();
    let speakingCooldown = 0;

    function say(text){
      if(!chkVoice.checked) return;
      const now = performance.now();
      if(now < speakingCooldown) return;
      speakingCooldown = now + 1200;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'es-AR';
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }

    function getConstraints(){
      const [w,h] = selRes.value.split('x').map(Number);
      return { audio:false, video:{ facingMode:'user', width:{ideal:w}, height:{ideal:h} } };
    }

    function angleABC(a,b,c){
      const abx = a.x - b.x, aby = a.y - b.y;
      const cbx = c.x - b.x, cby = c.y - b.y;
      const dot = abx*cbx + aby*cby;
      const mag = Math.hypot(abx,aby) * Math.hypot(cbx,cby) || 1e-6;
      const cos = Math.min(1, Math.max(-1, dot/mag));
      return Math.round(Math.acos(cos) * 180/Math.PI);
    }

    function safeLm(lms, idx){
      const lm = lms?.[idx];
      if(!lm) return null;
      if(lm.visibility !== undefined && lm.visibility < 0.1) return null;
      return lm;
    }

    function computeAngle(landmarks, exercise){
      if(!landmarks) return null;
      // Índices BlazePose (33 puntos):
      // hombro 11/12, codo 13/14, muñeca 15/16, cadera 23/24, rodilla 25/26, tobillo 27/28
      switch(exercise){
        case 'arm_right':{
          const sh = safeLm(landmarks,12);
          const el = safeLm(landmarks,14);
          const wr = safeLm(landmarks,16);
          if(!sh||!el||!wr) return null;
          return angleABC(sh,el,wr); // codo derecho
        }
        case 'arm_left':{
          const sh = safeLm(landmarks,11);
          const el = safeLm(landmarks,13);
          const wr = safeLm(landmarks,15);
          if(!sh||!el||!wr) return null;
          return angleABC(sh,el,wr); // codo izquierdo
        }
        case 'knee_right':{
          const hp = safeLm(landmarks,24);
          const kn = safeLm(landmarks,26);
          const an = safeLm(landmarks,28);
          if(!hp||!kn||!an) return null;
          return angleABC(hp,kn,an); // rodilla derecha
        }
        case 'knee_left':{
          const hp = safeLm(landmarks,23);
          const kn = safeLm(landmarks,25);
          const an = safeLm(landmarks,27);
          if(!hp||!kn||!an) return null;
          return angleABC(hp,kn,an); // rodilla izquierda
        }
      }
      return null;
    }

    function evalExercise(angle, exercise){
      if(angle==null) return {isUp:false,isDown:false,hints:['Cuerpo fuera de cuadro']};
      if(exercise.startsWith('arm')){
        // Brazo: up >= 160°, down <= 60°
        const hints=[]; if(angle<140) hints.push('Eleva más el brazo');
        return {isUp: angle>=160, isDown: angle<=60, hints};
      } else {
        // Rodilla: baja 60–90°, up >= 150°
        const hints=[]; if(angle>110) hints.push('Flexiona más la rodilla');
        return {isUp: angle>=150, isDown: angle<=90, hints};
      }
    }

    // ===== Inicialización de MediaPipe Tasks =====
    async function initPoseLandmarker(){
      const { FilesetResolver, PoseLandmarker, DrawingUtils } = window;
      const fileset = await FilesetResolver.forVisionTasks(
        'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/wasm'
      );
      landmarker = await PoseLandmarker.createFromOptions(fileset, {
        baseOptions: {
          modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_full/float16/latest/pose_landmarker_full.task'
        },
        runningMode: 'VIDEO',
        numPoses: 1,
        minPoseDetectionConfidence: 0.5,
        minPosePresenceConfidence: 0.5,
        minTrackingConfidence: 0.5
      });
      return { PoseLandmarker, DrawingUtils };
    }

    let drawingUtils = null; // instancia por canvas
    let PoseConnections = null;

    async function startCamera(){
      if(!landmarker){
        const { PoseLandmarker, DrawingUtils } = await initPoseLandmarker();
        drawingUtils = new DrawingUtils(ctx);
        PoseConnections = PoseLandmarker.POSE_CONNECTIONS;
      }
      const constraints = getConstraints();
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      videoEl.srcObject = stream; await videoEl.play();
      canvasEl.width = videoEl.videoWidth || 640;
      canvasEl.height = videoEl.videoHeight || 480;

      reps = 0; phase = 'down'; repsEl.textContent = '0';
      loop();
    }

    function stopCamera(){
      if(animId) cancelAnimationFrame(animId);
      animId = null;
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; }
      fpsEl.textContent = '–';
    }

    function loop(){
      const ts = performance.now();
      const w = videoEl.videoWidth, h = videoEl.videoHeight;
      canvasEl.width = w; canvasEl.height = h;

      const res = landmarker.detectForVideo(videoEl, ts);
      ctx.drawImage(videoEl, 0, 0, w, h);

      if(res && res.landmarks && res.landmarks.length){
        const lms = res.landmarks[0];
        // Dibujo del esqueleto
        drawingUtils.drawConnectors(lms, PoseConnections);
        drawingUtils.drawLandmarks(lms);

        // Ángulo por ejercicio
        const ang = computeAngle(lms, selExercise.value);
        angleEl.textContent = ang==null ? '–' : ang.toString();
        const {isUp,isDown,hints} = evalExercise(ang, selExercise.value);

        // Máquina de estados de conteo
        if(phase==='down' && isUp){ phase='up'; say('Arriba'); }
        else if(phase==='up' && isDown){ phase='down'; reps++; repsEl.textContent = reps.toString(); say('Correcto'); }

        // Hints de corrección
        if(hints.length && ang!=null){
          if(selExercise.value.startsWith('arm') && ang<140) say('Sube el brazo');
          if(selExercise.value.startsWith('knee') && ang>110) say('Flexiona más');
        }

        // Tarjeta de ángulo
        ctx.save();
        ctx.fillStyle = '#0e1530cc';
        ctx.strokeStyle = '#273055';
        ctx.lineWidth = 2;
        ctx.beginPath();
        roundRect(ctx, w-150, 12, 138, 48, 10);
        ctx.fill(); ctx.stroke();
        ctx.fillStyle = '#9fb2e8';
        ctx.font = '12px system-ui';
        ctx.fillText('Ángulo', w-135, 30);
        ctx.fillStyle = '#e9eefc';
        ctx.font = '22px system-ui';
        ctx.fillText(ang==null?'–':`${ang}°`, w-135, 50);
        ctx.restore();
      }

      // FPS
      frames++;
      if(ts - lastTs >= 1000){ fpsEl.textContent = String(frames); frames = 0; lastTs = ts; }
      animId = requestAnimationFrame(loop);
    }

    function roundRect(ctx,x,y,w,h,r){
      if(typeof r==='number'){ r={tl:r,tr:r,br:r,bl:r}; }
      ctx.moveTo(x+r.tl,y);
      ctx.lineTo(x+w-r.tr,y);
      ctx.quadraticCurveTo(x+w,y,x+w,y+r.tr);
      ctx.lineTo(x+w,y+h-r.br);
      ctx.quadraticCurveTo(x+w,y+h,x+w-r.br,y+h);
      ctx.lineTo(x+r.bl,y+h);
      ctx.quadraticCurveTo(x,y+h,x,y+h-r.bl);
      ctx.lineTo(x,y+r.tl);
      ctx.quadraticCurveTo(x,y,x+r.tl,y);
    }

    // Eventos UI
    btnStart.addEventListener('click', startCamera);
    btnStop.addEventListener('click', stopCamera);
    selRes.addEventListener('change', ()=>{ if(stream) { stopCamera(); startCamera(); } });
  </script>
</body>
</html>

